/** @author Laurent Cherpit */
Ext.namespace("Ext.ux.plugins");Ext.ux.plugins.HeaderButtons=function(b){Ext.apply(this,b)};Ext.extend(Ext.ux.plugins.HeaderButtons,Ext.util.Observable,{init:function(e){if(e.hbuttons){Ext.apply(e,{onRender:e.onRender.createSequence(function(c,o){if(this.headerButtons&&this.headerButtons.length>0){var n=this.header.createChild({cls:"ux-panel-header-btns-ct",cn:{cls:"ux-panel-header-btns",html:'<table cellspacing="0"><tbody><tr></tr></tbody></table><div class="x-clear"></div>'}},this.header.first("span",true),true);var b=n.getElementsByTagName("tr")[0];for(var d=0,p=this.headerButtons.length;d<p;d++){var q=this.headerButtons[d];var a=document.createElement("td");a.className="ux-panel-header-btn-td";q.render(b.appendChild(a))}}}),addHeaderButton:function(j,b,c){var a={handler:b,scope:c,hideParent:true};if(typeof j==="string"){a.text=j}else{Ext.apply(a,j)}var d=new Ext.Button(a);d.ownerCt=this;if(!this.headerButtons){this.headerButtons=[]}this.headerButtons.push(d);return d}});var g=e.hbuttons;e.headerButtons=[];for(var h=0,f=g.length;h<f;h++){if(g[h].render){e.headerButtons.push(g[h])}else{e.addHeaderButton(g[h])}}delete e.hbuttons}}});Ext.ns("Ext.ux.form");Ext.ux.form.MultiSelect=Ext.extend(Ext.form.Field,{appendOnly:false,width:100,height:100,displayField:0,valueField:1,allowBlank:true,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:Ext.form.TextField.prototype.blankText,minSelectionsText:"Minimum {0} item(s) required",maxSelectionsText:"Maximum {0} item(s) allowed",delimiter:",",defaultAutoCreate:{tag:"div"},initComponent:function(){Ext.ux.form.MultiSelect.superclass.initComponent.call(this);if(Ext.isArray(this.store)){if(Ext.isArray(this.store[0])){this.store=new Ext.data.ArrayStore({fields:["value","text"],data:this.store});this.valueField="value"}else{this.store=new Ext.data.ArrayStore({fields:["text"],data:this.store,expandData:true});this.valueField="text"}this.displayField="text"}else{this.store=Ext.StoreMgr.lookup(this.store)}this.addEvents({dblclick:true,click:true,change:true})},onRender:function(h,e){Ext.ux.form.MultiSelect.superclass.onRender.call(this,h,e);var f=this.fs=new Ext.form.FieldSet({renderTo:this.el,title:this.legend,height:this.height,width:this.width,style:this.style||{padding:"0"},tbar:this.tbar,bbar:this.bbar,fbar:this.fbar,bodyStyle:this.bodyStyle||"overflow: auto;padding:5px 0;"});this.view=new Ext.ListView({multiSelect:true,store:this.store,columns:[{header:"Value",width:1,dataIndex:this.displayField}],hideHeaders:true,simpleSelect:this.simpleSelect||false,loadingText:this.loadingText||"Wait ..."});f.add(this.view);this.view.on("click",this.onViewClick,this);this.view.on("beforeclick",this.onViewBeforeClick,this);this.view.on("dblclick",this.onViewDblClick,this);this.hiddenName=this.name||Ext.id();var g={tag:"input",type:"hidden",value:"",name:this.hiddenName};this.hiddenField=this.el.createChild(g);this.hiddenField.dom.disabled=this.hiddenName!=this.name;f.doLayout()},afterRender:function(){Ext.ux.form.MultiSelect.superclass.afterRender.call(this)},onViewClick:function(k,g,e,h){var j=this.view.getSelectedIndexes();if(j.indexOf(0)!==-1){if(j.length>1&&g===0){this.setValue("0")}else{if(g!==0){this.view.deselect(0)}}}this.fireEvent("change",this,this.getValue(),this.hiddenField.dom.value);this.hiddenField.dom.value=this.getValue();this.fireEvent("click",this,h);this.validate()},onViewBeforeClick:function(h,f,e,g){if(this.disabled){return false}},onViewDblClick:function(h,f,e,g){return this.fireEvent("dblclick",h,f,e,g)},getValue:function(f){var g=[];var h=this.view.getSelectedIndexes();if(h.length==0){return""}for(var e=0;e<h.length;e++){g.push(this.store.getAt(h[e]).get((f!=null)?f:this.valueField))}return g.join(this.delimiter)},setValue:function(f){var e;var g=[];this.view.clearSelections();this.hiddenField.dom.value="";if(!f||(f=="")){return}if(!Ext.isArray(f)){f=f.split(this.delimiter)}for(var h=0;h<f.length;h++){e=this.view.store.indexOf(this.view.store.query(this.valueField,new RegExp("^"+f[h]+"$","i")).itemAt(0));g.push(e)}this.view.select(g);this.hiddenField.dom.value=this.getValue();this.validate()},reset:function(){this.fireEvent("reset",this);this.setValue("");this.fireEvent("afterreset",this)},getRawValue:function(d){var c=this.getValue(d);if(c.length){c=c.split(this.delimiter)}else{c=[]}return c},setRawValue:function(b){setValue(b)},validateValue:function(b){if(b.length<1){if(this.allowBlank){this.clearInvalid();return true}else{this.markInvalid(this.blankText);return false}}if(b.length<this.minSelections){this.markInvalid(String.format(this.minSelectionsText,this.minSelections));return false}if(b.length>this.maxSelections){this.markInvalid(String.format(this.maxSelectionsText,this.maxSelections));return false}return true},disable:function(){this.disabled=true;this.hiddenField.dom.disabled=true;this.fs.disable()},enable:function(){this.disabled=false;this.hiddenField.dom.disabled=false;this.fs.enable()},destroy:function(){Ext.ux.form.MultiSelect.superclass.destroy.call(this)}});Ext.reg("multiselect",Ext.ux.form.MultiSelect);Ext.ux.MsgBus=function(b){Ext.apply(this,b,{})};Ext.override(Ext.ux.MsgBus,{busName:"Ext.ux.Bus",bus:false,init:function(b){this.cmp=b;b.bus=this.getBus();b.bus.addEvents("message");b.subs={};this.applyConfig()},getBus:function(){var f=window;var a=this.busName.split(".");var e=a.pop();Ext.each(a,function(b){if(!Ext.isObject(f[b])){f=false;return false}else{f=f[b]}},this);if(false===f){Ext.ns(this.busName);return this.getBus()}if(!(f[e] instanceof Ext.util.Observable)){f[e]=new Ext.util.Observable()}return f[e]},getFilterRe:function(h){var a=h.split(".");var f=a.length-1;a[f]="**"===a[f]?".*":a[f];var g=/^\w+$/;Ext.each(a,function(c,b){if(!g.test(c)&&"*"!==c&&".*"!==c){throw"Invalid subject: "+h}if("*"===c){a[b]="\\w+"}});return new RegExp("^"+a.join("\\.")+"$")},applyConfig:function(){Ext.applyIf(this.cmp,{subscribe:function(d,e){var f=this.subs[d];if(f){return false}e=e||{};e.filter=this.getFilterRe(d);this.subs[d]={config:e,fn:this.filterMessage.createDelegate(this,[e],true)};this.bus.on("message",this.subs[d].fn,e.scope||this,e);return true},unsubscribe:function(d){var c=this.subs[d];if(!c){return false}this.bus.un("message",c.fn,c.scope||this,c.config);delete this.subs[d];c=null;return true},publish:function(d,c){this.getFilterRe(d);this.bus.fireEvent("message",d,c)},getSubscriptions:function(){return this.subs},getFilterRe:this.getFilterRe,filterMessage:function(d,f,e){if(e.filter.test(d)){(e.fn||this.onMessage).call(e.scope||this,d,f)}},onMessage:Ext.emptyFn})}});Ext.preg("msgbus",Ext.ux.MsgBus);Ext.ns("Ext.ux.menu");Ext.ux.menu.RangeMenu=Ext.extend(Ext.menu.Menu,{constructor:function(m){Ext.ux.menu.RangeMenu.superclass.constructor.call(this,m);this.addEvents("update");this.updateTask=new Ext.util.DelayedTask(this.fireUpdate,this);var l,h,k,g,j;for(l=0,h=this.menuItems.length;l<h;l++){k=this.menuItems[l];if(k!=="-"){g={itemId:"range-"+k,enableKeyEvents:true,iconCls:this.iconCls[k]||"no-icon",listeners:{scope:this,keyup:this.onInputKeyUp}};Ext.apply(g,Ext.applyIf(this.fields[k]||{},this.fieldCfg[k]),this.menuItemCfgs);j=g.fieldCls||this.fieldCls;k=this.fields[k]=new j(g)}this.add(k)}},fireUpdate:function(){this.fireEvent("update",this)},getValue:function(){var e={},d,f;for(d in this.fields){f=this.fields[d];if(f.isValid()&&String(f.getValue()).length>0){e[d]=f.getValue()}}return e},setValue:function(c){var d;for(d in this.fields){this.fields[d].setValue(c[d]!==undefined?c[d]:"")}this.fireEvent("update",this)},onInputKeyUp:function(f,d){var e=d.getKey();if(e==d.RETURN&&f.isValid()){d.stopEvent();this.hide(true);return}if(f==this.fields.eq){if(this.fields.gt){this.fields.gt.setValue(null)}if(this.fields.lt){this.fields.lt.setValue(null)}}else{this.fields.eq.setValue(null)}this.updateTask.delay(this.updateBuffer)}});Ext.namespace("Ext.ux.grid");Ext.ux.grid.GridFilters=Ext.extend(Ext.util.Observable,{autoReload:true,filterCls:"ux-filtered-column",local:false,menuFilterText:"Filters",paramPrefix:"filter",showMenu:true,stateId:undefined,updateBuffer:500,constructor:function(b){this.deferredUpdate=new Ext.util.DelayedTask(this.reload,this);this.filters=new Ext.util.MixedCollection();this.filters.getKey=function(a){return a?a.dataIndex:null};this.addFilters(b.filters);delete b.filters;Ext.apply(this,b)},init:function(b){if(b instanceof Ext.grid.GridPanel){this.grid=b;this.bindStore(this.grid.getStore(),true);this.grid.filters=this;this.grid.addEvents({filterupdate:true});b.on({scope:this,beforestaterestore:this.applyState,beforestatesave:this.saveState,beforedestroy:this.destroy,reconfigure:this.onReconfigure});if(b.rendered){this.onRender()}else{b.on({scope:this,single:true,render:this.onRender})}}else{if(b instanceof Ext.PagingToolbar){this.toolbar=b}}},applyState:function(e,g){var f,h;this.applyingState=true;this.clearFilters();if(g.filters){for(f in g.filters){h=this.filters.get(f);if(h){h.setValue(g.filters[f]);h.setActive(true)}}}this.deferredUpdate.cancel();if(this.local){this.reload()}delete this.applyingState},saveState:function(e,f){var d={};this.filters.each(function(a){if(a.active){d[a.dataIndex]=a.getValue()}});return(f.filters=d)},onRender:function(){this.grid.getView().on("refresh",this.onRefresh,this);this.createMenu()},destroy:function(){this.removeAll();this.purgeListeners();if(this.filterMenu){Ext.menu.MenuMgr.unregister(this.filterMenu);this.filterMenu.destroy();this.filterMenu=this.menu.menu=null}},removeAll:function(){if(this.filters){Ext.destroy.apply(Ext,this.filters.items);this.filters.clear()}},bindStore:function(d,c){if(!c&&this.store){if(this.local){d.un("load",this.onLoad,this)}else{d.un("beforeload",this.onBeforeLoad,this)}}if(d){if(this.local){d.on("load",this.onLoad,this)}else{d.on("beforeload",this.onBeforeLoad,this)}}this.store=d},onReconfigure:function(){this.bindStore(this.grid.getStore());this.store.clearFilter();this.removeAll();this.addFilters(this.grid.getColumnModel());this.updateColumnHeadings()},createMenu:function(){var d=this.grid.getView(),c=d.hmenu;if(this.showMenu&&c){this.sep=c.addSeparator();this.filterMenu=new Ext.menu.Menu({id:this.grid.id+"-filters-menu"});this.menu=c.add({checked:false,itemId:"filters",text:this.menuFilterText,menu:this.filterMenu});this.menu.on({scope:this,checkchange:this.onCheckChange,beforecheckchange:this.onBeforeCheck});c.on("beforeshow",this.onMenu,this)}this.updateColumnHeadings()},getMenuFilter:function(){var b=this.grid.getView();if(!b||b.hdCtxIndex===undefined){return null}return this.filters.get(b.cm.config[b.hdCtxIndex].dataIndex)},onMenu:function(c){var d=this.getMenuFilter();if(d){this.menu.menu=d.menu;this.menu.setChecked(d.active,false);this.menu.setDisabled(d.disabled===true)}this.menu.setVisible(d!==undefined);this.sep.setVisible(d!==undefined)},onCheckChange:function(d,c){this.getMenuFilter().setActive(c)},onBeforeCheck:function(d,c){return !c||this.getMenuFilter().isActivatable()},onStateChange:function(c,d){if(c==="serialize"){return}if(d==this.getMenuFilter()){this.menu.setChecked(d.active,false)}if((this.autoReload||this.local)&&!this.applyingState){this.deferredUpdate.delay(this.updateBuffer)}this.updateColumnHeadings();if(!this.applyingState){this.grid.saveState()}this.grid.fireEvent("filterupdate",this,d)},onBeforeLoad:function(e,d){d.params=d.params||{};this.cleanParams(d.params);var f=this.buildQuery(this.getFilterData());Ext.apply(d.params,f)},onLoad:function(d,c){d.filterBy(this.getRecordFilter())},onRefresh:function(){this.updateColumnHeadings()},updateColumnHeadings:function(){var f=this.grid.getView(),h,k,g,j;if(f.mainHd){h=f.mainHd.select("td").removeClass(this.filterCls);for(k=0,g=f.cm.config.length;k<g;k++){j=this.getFilter(f.cm.config[k].dataIndex);if(j&&j.active){h.item(k).addClass(this.filterCls)}}}},reload:function(){if(this.local){this.grid.store.clearFilter(true);this.grid.store.filterBy(this.getRecordFilter())}else{var c,d=this.grid.store;this.deferredUpdate.cancel();if(this.toolbar){c=d.paramNames.start;if(d.lastOptions&&d.lastOptions.params&&d.lastOptions.params[c]){d.lastOptions.params[c]=0}}d.reload()}},getRecordFilter:function(){var f=[],e,d;this.filters.each(function(a){if(a.active){f.push(a)}});e=f.length;return function(a){for(d=0;d<e;d++){if(!f[d].validateRecord(a)){return false}}return true}},addFilter:function(e){var f=this.getFilterClass(e.type),d=e.menu?e:(new f(e));this.filters.add(d);Ext.util.Observable.capture(d,this.onStateChange,this);return d},addFilters:function(j){if(j){var m,g,k,h=false,l;if(j instanceof Ext.grid.ColumnModel){j=j.config;h=true}for(m=0,g=j.length;m<g;m++){k=false;if(h){l=j[m].dataIndex;k=j[m].filter||j[m].filterable;if(k){k=(k===true)?{}:k;Ext.apply(k,{dataIndex:l});k.type=k.type||this.store.fields.get(l).type}}else{k=j[m]}if(k){this.addFilter(k)}}}},getFilter:function(b){return this.filters.get(b)},clearFilters:function(){this.filters.each(function(b){b.setActive(false)})},getFilterData:function(){var f=[],d,e;this.filters.each(function(b){if(b.active){var a=[].concat(b.serialize());for(d=0,e=a.length;d<e;d++){f.push({field:b.dataIndex,data:a[d]})}}});return f},buildQuery:function(r){var s={},q,m,l,o,f,p,n=r.length;if(!this.encode){for(q=0;q<n;q++){m=r[q];l=[this.paramPrefix,"[",q,"]"].join("");s[l+"[field]"]=m.field;o=l+"[data]";for(f in m.data){s[[o,"[",f,"]"].join("")]=m.data[f]}}}else{p=[];for(q=0;q<n;q++){m=r[q];p.push(Ext.apply({},{field:m.field},m.data))}if(p.length>0){s[this.paramPrefix]=Ext.util.JSON.encode(p)}}return s},cleanParams:function(f){if(this.encode){delete f[this.paramPrefix]}else{var d,e;d=new RegExp("^"+this.paramPrefix+"[[0-9]+]");for(e in f){if(d.test(e)){delete f[e]}}}},getFilterClass:function(b){switch(b){case"auto":b="string";break;case"int":case"float":b="numeric";break}return Ext.ux.grid.filter[b.substr(0,1).toUpperCase()+b.substr(1)+"Filter"]}});Ext.preg("gridfilters",Ext.ux.grid.GridFilters);Ext.namespace("Ext.ux.grid.filter");Ext.ux.grid.filter.Filter=Ext.extend(Ext.util.Observable,{active:false,dataIndex:null,menu:null,updateBuffer:500,constructor:function(b){Ext.apply(this,b);this.addEvents("activate","deactivate","serialize","update");Ext.ux.grid.filter.Filter.superclass.constructor.call(this);this.menu=new Ext.menu.Menu();this.init(b);if(b&&b.value){this.setValue(b.value);this.setActive(b.active!==false,true);delete b.value}},destroy:function(){if(this.menu){this.menu.destroy()}this.purgeListeners()},init:Ext.emptyFn,getValue:Ext.emptyFn,setValue:Ext.emptyFn,isActivatable:function(){return true},getSerialArgs:Ext.emptyFn,validateRecord:function(){return true},serialize:function(){var b=this.getSerialArgs();this.fireEvent("serialize",b,this);return b},fireUpdate:function(){if(this.active){this.fireEvent("update",this)}this.setActive(this.isActivatable())},setActive:function(c,d){if(this.active!=c){this.active=c;if(d!==true){this.fireEvent(c?"activate":"deactivate",this)}}}});Ext.ux.grid.filter.StringFilter=Ext.extend(Ext.ux.grid.filter.Filter,{iconCls:"ux-gridfilter-text-icon",emptyText:"Enter Filter Text...",selectOnFocus:true,width:125,init:function(b){Ext.applyIf(b,{enableKeyEvents:true,iconCls:this.iconCls,listeners:{scope:this,keyup:this.onInputKeyUp}});this.inputItem=new Ext.form.TextField(b);this.menu.add(this.inputItem);this.updateTask=new Ext.util.DelayedTask(this.fireUpdate,this)},getValue:function(){return this.inputItem.getValue()},setValue:function(b){this.inputItem.setValue(b);this.fireEvent("update",this)},isActivatable:function(){return this.inputItem.getValue().length>0},getSerialArgs:function(){return{type:"string",value:this.getValue()}},validateRecord:function(d){var c=d.get(this.dataIndex);if(typeof c!="string"){return(this.getValue().length===0)}return c.toLowerCase().indexOf(this.getValue().toLowerCase())>-1},onInputKeyUp:function(f,d){var e=d.getKey();if(e==d.RETURN&&f.isValid()){d.stopEvent();this.menu.hide(true);return}this.updateTask.delay(this.updateBuffer)}});Ext.ux.grid.filter.DateFilter=Ext.extend(Ext.ux.grid.filter.Filter,{afterText:"After",beforeText:"Before",compareMap:{before:"lt",after:"gt",on:"eq"},dateFormat:"m/d/Y",menuItems:["before","after","-","on"],menuItemCfgs:{selectOnFocus:true,width:125},onText:"On",pickerOpts:{},init:function(o){var k,n,j,m,h,l;k=Ext.apply(this.pickerOpts,{minDate:this.minDate,maxDate:this.maxDate,format:this.dateFormat,listeners:{scope:this,select:this.onMenuSelect}});this.fields={};for(n=0,j=this.menuItems.length;n<j;n++){m=this.menuItems[n];if(m!=="-"){h={itemId:"range-"+m,text:this[m+"Text"],menu:new Ext.menu.DateMenu(Ext.apply(k,{itemId:m})),listeners:{scope:this,checkchange:this.onCheckChange}};l=Ext.menu.CheckItem;m=this.fields[m]=new l(h)}this.menu.add(m)}},onCheckChange:function(){this.setActive(this.isActivatable());this.fireEvent("update",this)},onInputKeyUp:function(f,d){var e=d.getKey();if(e==d.RETURN&&f.isValid()){d.stopEvent();this.menu.hide(true);return}},onMenuSelect:function(k,j,f){var g=this.fields,h=this.fields[k.itemId];h.setChecked(true);if(h==g.on){g.before.setChecked(false,true);g.after.setChecked(false,true)}else{g.on.setChecked(false,true);if(h==g.after&&g.before.menu.picker.value<j){g.before.setChecked(false,true)}else{if(h==g.before&&g.after.menu.picker.value>j){g.after.setChecked(false,true)}}}this.fireEvent("update",this)},getValue:function(){var c,d={};for(c in this.fields){if(this.fields[c].checked){d[c]=this.fields[c].menu.picker.getValue()}}return d},setValue:function(f,d){var e;for(e in this.fields){if(f[e]){this.fields[e].menu.picker.setValue(f[e]);this.fields[e].setChecked(true)}else{if(!d){this.fields[e].setChecked(false)}}}this.fireEvent("update",this)},isActivatable:function(){var b;for(b in this.fields){if(this.fields[b].checked){return true}}return false},getSerialArgs:function(){var d=[];for(var c in this.fields){if(this.fields[c].checked){d.push({type:"date",comparison:this.compareMap[c],value:this.getFieldValue(c).format(this.dateFormat)})}}return d},getFieldValue:function(b){return this.fields[b].menu.picker.getValue()},getPicker:function(b){return this.fields[b].menu.picker},validateRecord:function(f){var e,g,h=f.get(this.dataIndex).clearTime(true).getTime();for(e in this.fields){if(this.fields[e].checked){g=this.getFieldValue(e).clearTime(true).getTime();if(e=="before"&&g<=h){return false}if(e=="after"&&g>=h){return false}if(e=="on"&&g!=h){return false}}}return true}});Ext.ns("Ext.ux.grid");Ext.ux.grid.RowExpander=Ext.extend(Ext.util.Observable,{expandOnEnter:true,expandOnDblClick:true,header:"",width:20,sortable:false,fixed:true,menuDisabled:true,dataIndex:"",id:"expander",lazyRender:true,enableCaching:true,constructor:function(b){Ext.apply(this,b);this.addEvents({beforeexpand:true,expand:true,beforecollapse:true,collapse:true});Ext.ux.grid.RowExpander.superclass.constructor.call(this);if(this.tpl){if(typeof this.tpl=="string"){this.tpl=new Ext.Template(this.tpl)}this.tpl.compile()}this.state={};this.bodyContent={}},getRowClass:function(g,h,j,k){j.cols=j.cols-1;var f=this.bodyContent[g.id];if(!f&&!this.lazyRender){f=this.getBodyContent(g,h)}if(f){j.body=f}return this.state[g.id]?"x-grid3-row-expanded":"x-grid3-row-collapsed"},init:function(c){this.grid=c;var d=c.getView();d.getRowClass=this.getRowClass.createDelegate(this);d.enableRowBody=true;c.on("render",this.onRender,this);c.on("destroy",this.onDestroy,this)},onRender:function(){var d=this.grid;var c=d.getView().mainBody;c.on("mousedown",this.onMouseDown,this,{delegate:".x-grid3-row-expander"});if(this.expandOnEnter){this.keyNav=new Ext.KeyNav(this.grid.getGridEl(),{enter:this.onEnter,scope:this})}if(this.expandOnDblClick){d.on("rowdblclick",this.onRowDblClick,this)}},onDestroy:function(){if(this.keyNav){this.keyNav.disable();delete this.keyNav}var b=this.grid.getView().mainBody;if(b){b.un("mousedown",this.onMouseDown,this)}},onRowDblClick:function(e,d,f){this.toggleRow(d)},onEnter:function(l){var m=this.grid;var k=m.getSelectionModel();var e=k.getSelections();for(var o=0,g=e.length;o<g;o++){var n=m.getStore().indexOf(e[o]);this.toggleRow(n)}},getBodyContent:function(e,d){if(!this.enableCaching){return this.tpl.apply(e.data)}var f=this.bodyContent[e.id];if(!f){f=this.tpl.apply(e.data);this.bodyContent[e.id]=f}return f},onMouseDown:function(d,e){d.stopEvent();var f=d.getTarget(".x-grid3-row");this.toggleRow(f)},renderer:function(d,f,e){f.cellAttr='rowspan="2"';return'<div class="x-grid3-row-expander">&#160;</div>'},beforeExpand:function(d,e,f){if(this.fireEvent("beforeexpand",this,d,e,f)!==false){if(this.tpl&&this.lazyRender){e.innerHTML=this.getBodyContent(d,f)}return true}else{return false}},toggleRow:function(b){if(typeof b=="number"){b=this.grid.view.getRow(b)}this[Ext.fly(b).hasClass("x-grid3-row-collapsed")?"expandRow":"collapseRow"](b)},expandRow:function(f){if(typeof f=="number"){f=this.grid.view.getRow(f)}var d=this.grid.store.getAt(f.rowIndex);var e=Ext.DomQuery.selectNode("tr:nth(2) div.x-grid3-row-body",f);if(this.beforeExpand(d,e,f.rowIndex)){this.state[d.id]=true;Ext.fly(f).replaceClass("x-grid3-row-collapsed","x-grid3-row-expanded");this.fireEvent("expand",this,d,e,f.rowIndex)}},collapseRow:function(f){if(typeof f=="number"){f=this.grid.view.getRow(f)}var d=this.grid.store.getAt(f.rowIndex);var e=Ext.fly(f).child("tr:nth(1) div.x-grid3-row-body",true);if(this.fireEvent("beforecollapse",this,d,e,f.rowIndex)!==false){this.state[d.id]=false;Ext.fly(f).replaceClass("x-grid3-row-expanded","x-grid3-row-collapsed");this.fireEvent("collapse",this,d,e,f.rowIndex)}}});Ext.preg("rowexpander",Ext.ux.grid.RowExpander);Ext.grid.RowExpander=Ext.ux.grid.RowExpander;Ext.ux.PageSizePlugin=function(b){Ext.apply(this,b);Ext.ux.PageSizePlugin.superclass.constructor.call(this,{store:new Ext.data.SimpleStore({fields:["text","value"],data:[["5",5],["10",10],["15",15],["20",20],["25",25],["50",50],["100",100]]}),mode:"local",displayField:"text",valueField:"value",allowBlank:false,triggerAction:"all",width:50,maskRe:/[0-9]/})};Ext.extend(Ext.ux.PageSizePlugin,Ext.form.ComboBox,{beforeText:"",afterText:"/page",init:function(b){b.on("render",this.onInitView,this)},onInitView:function(b){b.insert(11,"-",this.beforeText,this,this.afterText);this.setValue(b.pageSize);this.on("select",this.onPageSizeChanged,b);this.on("specialkey",function(d,a){if(13===a.getKey()){this.onPageSizeChanged.call(b,this)}})},onPageSizeChanged:function(b){this.pageSize=parseInt(b.getRawValue(),10);this.doLoad(0)}});Ext.ns("DocDb");DocDb.OwnersList=Ext.extend(Ext.ux.form.MultiSelect,{border:false,initComponent:function(){var b={name:"owner",plugins:["msgbus"],store:new Ext.data.DirectStore({root:"result",fields:[{name:"id",type:"int"},{name:"owner",type:"string"}],baseParams:{sort:"owner",dir:"ASC"},remoteSort:true,directFn:DocDb.model_owner.get}),valueField:"id",displayField:"owner",simpleSelect:false};Ext.apply(this,Ext.apply(this.initialConfig,b));DocDb.OwnersList.superclass.initComponent.apply(this,arguments);this.store.on("load",function(){var e=this.store.query("id",0);var f=this.store.indexOfId(e.keys[0]);var a=this.store.getAt(f);a.data.owner=this.labelAll;this.store.removeAt(f);this.store.insert(f,a);this.setValue("0")},this);this.on("change",function(a,d){this.publish("doccb.owner.selected",{obj:this,val:d})},this,{buffer:800,stopEvent:true});this.on("reset",function(a){this.publish("doccb.owner.reset",{obj:a})},this);this.on("afterreset",function(a){this.setValue("0")})},afterRender:function(){this.store.load();DocDb.OwnersList.superclass.afterRender.apply(this,arguments)}});Ext.reg("ownerslist",DocDb.OwnersList);Ext.ns("DocDb");DocDb.TypesList=Ext.extend(Ext.ux.form.MultiSelect,{border:false,initComponent:function(){var b={name:"type",plugins:["msgbus"],store:new Ext.data.DirectStore({root:"result",fields:[{name:"id",type:"int"},{name:"type",type:"string"}],baseParams:{sort:"type",dir:"ASC"},remoteSort:true,directFn:DocDb.model_type.get}),valueField:"id",displayField:"type",simpleSelect:false};Ext.apply(this,Ext.apply(this.initialConfig,b));DocDb.TypesList.superclass.initComponent.apply(this,arguments);this.store.on("load",function(){var e=this.store.query("id",0);var f=this.store.indexOfId(e.keys[0]);var a=this.store.getAt(f);a.data.type=this.labelAll;this.store.removeAt(f);this.store.insert(f,a);this.setValue("0")},this);this.on("reset",function(a){this.store.load()});this.on("change",function(a,d){this.publish("doccb.type.selected",{obj:this,val:d})},this,{buffer:800,stopEvent:true})},onRender:function(){DocDb.TypesList.superclass.onRender.apply(this,arguments);this.subscribe("doccb.owner.selected",{fn:this.getRelatedTypes,single:false})},afterRender:function(){DocDb.TypesList.superclass.afterRender.apply(this,arguments);this.store.load()},getRelatedTypes:function(d,c){if(c.val.length<1){this.store.load()}else{this.store.load({params:{ownerfk:c.val}})}}});Ext.reg("typeslist",DocDb.TypesList);Ext.ns("DocDb");DocDb.StatusList=Ext.extend(Ext.ux.form.MultiSelect,{border:false,initComponent:function(){var b={name:"status",plugins:["msgbus"],store:new Ext.data.DirectStore({root:"result",fields:[{name:"id",type:"int"},{name:"status",type:"string"}],baseParams:{sort:"status",dir:"ASC"},remoteSort:true,directFn:DocDb.model_status.get}),valueField:"id",displayField:"status",simpleSelect:false};Ext.apply(this,Ext.apply(this.initialConfig,b));DocDb.StatusList.superclass.initComponent.apply(this,arguments);this.store.on("load",function(){var e=this.store.query("id",0);var f=this.store.indexOfId(e.keys[0]);var a=this.store.getAt(f);a.data.status=this.labelAll;this.store.removeAt(f);this.store.insert(f,a);this.setValue("0")},this);this.on("reset",function(a){this.store.load()});this.on("change",function(a,d){this.publish("doccb.status.selected",{obj:this,val:d})},this,{buffer:800,stopEvent:true})},onRender:function(){DocDb.OwnersList.superclass.onRender.apply(this,arguments);this.subscribe("doccb.owner.selected",{fn:this.getRelatedStatus,single:false});this.subscribe("doccb.type.selected",{fn:this.getRelatedStatus,single:false})},afterRender:function(){DocDb.StatusList.superclass.afterRender.apply(this,arguments);this.store.load()},getRelatedStatus:function(d,f){var e={};if(f.val.length<1){this.store.load()}else{if(d==="doccb.owner.selected"){e={params:{ownerfk:f.val}}}else{if(d==="doccb.type.selected"){if(Ext.isDefined(this.store.lastOptions.params)){e=this.store.lastOptions}else{e.params={}}e.params.typefk=f.val}}this.store.load(e)}}});Ext.reg("statuslist",DocDb.StatusList);Ext.ns("Ext.ux");Ext.ux.DscrLoader=Ext.extend(Ext.tree.TreeLoader,{addIconRelDscr:function(a){if(a.relDscr){a.text='<img class="x-tree-node-relDscr" src="'+Ext.BLANK_IMAGE_URL+'" /> '+a.text;a.qtip="<b>Rel.:</b><br />";for(i=0;i<a.relDscr.length;i++){a.qtip+="<p>- "+a.relDscr[i].title+"</p>"}}},createNode:function(a){this.addIconRelDscr(a);return Ext.ux.DscrLoader.superclass.createNode.call(this,a)}});Ext.ns("DocDb");DocDb.DescriptorsTree=Ext.extend(Ext.tree.TreePanel,{border:false,initComponent:function(){var a={height:this.treeHeight.min-35,width:this.width,bodyStyle:"overflow: hidden;",unstyled:false,animate:false,autoScroll:false,containerScroll:true,rootVisible:false,lines:false,useArrows:true,plugins:["msgbus",new Ext.ux.plugins.HeaderButtons()],hbuttons:[{text:this.lang.search,tooltip:this.lang.searchTip,xtype:"button",id:"btnFormSubmit",iconCls:"x-btn-search"},{text:this.lang.reset,tooltip:this.lang.resetTip,xtype:"button",id:"btn-form-reset",handler:function(b,c){delete this.ownerCt.loader.baseParams;this.ownerCt.loader.baseParams={};this.ownerCt.ownerCt.form.reset();if(this.ownerCt.searchIsOn){this.ownerCt.trigger.onTriggerClick()}else{this.ownerCt.collapseAll()}}}],root:{id:"root",text:"Root",children:this.treeNodes},loader:new Ext.ux.DscrLoader({directFn:DocDb.model_descriptor.get,paramsAsHash:true}),searchIsOn:false,tbar:[" ",{xtype:"checkbox",id:"chkAllDscr",checked:false,boxLabel:this.lang.all||"All",name:"selAll",inputValue:"selAll"}," ","-"," ","Combinaison"," ",{xtype:"radio",id:"selTypeAnd",boxLabel:this.lang.and,name:"selType",inputValue:"AND"}," ",{xtype:"radio",id:"selTypeOr",checked:true,boxLabel:this.lang.or,name:"selType",inputValue:"OR"}," ","-",{xtype:"button",id:"btnCollapse",text:"",iconCls:"x-btn-text icon-collapse-all",tooltip:this.lang.clpseAll},"->","-",this.lang.filter,{xtype:"trigger",id:"treeFilter",tree:this,triggerClass:"x-form-clear-trigger",emptyText:this.lang.filterEmpTxt,onTriggerClick:function(){this.onTriggerClick()},enableKeyEvents:true,minLength:4,maxLength:50,vtype:"alphanumMask"}]};Ext.apply(this,Ext.apply(this.initialConfig,a));DocDb.DescriptorsTree.superclass.initComponent.apply(this,arguments);this.on("beforeclick",function(b,c){b.ui.toggleCheck()});this.on("checkchange",function(c,d){var b=d?"checked":"unchecked";if(c.isLeaf()){this.bubbleSetStyle(c,d);if(!this.searchIsOn){DocDb.model_descriptor.setSessionNode(c.id,b)}}},this);this.on("beforeexpandnode",function(b,c){if(!this.searchIsOn){DocDb.model_descriptor.setSessionNode(b.id,"expand")}});this.on("beforecollapsenode",function(b,c){Ext.each(this.getChecked("",b),function(e,d){e.ui.toggleCheck(false)});DocDb.model_descriptor.setSessionNode(b.id,"collapse")});this.on("expandnode",function(b){this.applyAttrToChildrenOfNode(b);if(b.getDepth()===0){Ext.each(this.getChecked(),function(c){this.bubbleSetStyle(c,true)},this)}b.isAlreadyExpanded=true;this.resizeTreePanel()},this,{buffer:10});this.on("collapsenode",function(b){b.collapseChildNodes(true);this.resizeTreePanel()});this.loader.on("beforeload",function(b,c){if(this.body.isMasked()){this.body.unmask()}},this);this.loader.on("load",function(c,d,b){if(this.searchIsOn){this.expandAll();if(b.responseText[0].id==="nores"){(function(){this.body.mask(this.lang.noResult,"x-mask")}.defer(20,this))}}d.isAlreadyExpanded=false},this)},resizeTreePanel:function(){var e=Ext.getCmp("mainPanel");var a=Ext.getCmp("advSearch");var c=Ext.get("mSelect");var d=0;var b=(parseInt(this.getTreeEl().dom.firstElementChild.clientHeight,10)+Math.ceil(this.getFrameHeight()*1.5));if(b<=this.treeHeight.min){d=(c.getHeight()+this.treeHeight.min);b=this.treeHeight.min}else{if(b>=this.treeHeight.max){d=(c.getHeight()+(this.treeHeight.max+Math.ceil(this.getFrameHeight()*0.5)));b=this.treeHeight.max;this.body.setStyle("overflow-y","auto")}else{d=(c.getHeight()+b);this.body.setStyle("overflow","hidden")}}this.setHeight(b);a.setHeight(d);e.setHeight(d);this.syncSize();e.doLayout()},updateqt:function(b,c,a){if(b.getUI().textNode.setAttributeNS){b.getUI().textNode.setAttributeNS("ext","qtip",c);if(a){b.getUI().textNode.setAttributeNS("ext","qtitle",a)}}else{b.getUI().textNode.setAttribute("ext:qtip",c);if(a){b.getUI().textNode.setAttribute("ext:qtitle",a)}}},bubbleSetStyle:function(a,b){a.bubble(function(c){if(b){c.ui.addClass("xtree-node-checked")}else{if(this.getChecked("",c.parentNode).length<1||this.getChecked("",c).length<1){c.ui.removeClass("xtree-node-checked")}}},this)},applyAttrToChildrenOfNode:function(a){if(a.firstChild&&a.firstChild.isLeaf()&&!a.isAlreadyExpanded){a.eachChild(function(e,b){var d=e.ui.elNode.lastElementChild;var c=(d.offsetLeft+d.offsetWidth);if(c>(this.width-20)){this.updateqt(e,e.qtip+"<br />"+e.attributes.text)}},this)}},disableBodyTree:function(d,e){var c=Ext.getCmp("mainPanel");var b=Ext.getCmp("selTypeAnd");var a=Ext.getCmp("selTypeOr");if(e){b.disable();a.disable();this.trigger.disable();this.btClpsAll.disable();this.collapseAll();this.body.mask(this.lang.allDscrSelected,"x-mask")}else{b.enable();a.enable();this.trigger.enable();this.btClpsAll.enable();this.body.unmask()}},onRender:function(){var a=function(b){this.val=b};DocDb.DescriptorsTree.superclass.onRender.apply(this,arguments);this.chkAll=Ext.getCmp("chkAllDscr");this.btClpsAll=Ext.getCmp("btnCollapse");this.trigger=Ext.getCmp("treeFilter");this.origRootChildren=new a(this.getRootNode().attributes.children);this.subscribe("doccb.owner.selected",{fn:this.getRelatedDescriptors,single:false});this.subscribe("doccb.type.selected",{fn:this.getRelatedDescriptors,single:false});this.subscribe("doccb.status.selected",{fn:this.getRelatedDescriptors,single:false})},afterRender:function(a){DocDb.DescriptorsTree.superclass.afterRender.apply(this,arguments);this.btClpsAll.on("click",function(){this.collapseAll()},this);this.chkAll.on("check",this.disableBodyTree,this);this.trigger.onTriggerClick=function(c){this.setValue("");var b=this.tree;if(b.searchIsOn){delete b.loader.baseParams.needle;b.searchIsOn=false;b.loader.load(b.getRootNode());if(b.body.isMasked()){b.body.unmask()}}};this.trigger.on("blur",function(b){if(b.getValue().length<4&&this.searchIsOn){this.searchIsOn=true;b.onTriggerClick()}},this);this.trigger.on("keyup",function(c,b){if((b.isNavKeyPress()||b.isSpecialKey())&&b.getKey()!==b.BACKSPACE&&b.getKey()!==b.ENTER){return false}if(c.validateValue(c.getValue())){if(c.getValue().length<4){c.markInvalid();return false}this.loader.baseParams.needle=c.getValue();delete this.getRootNode().attributes.children;this.collapseAll();this.loader.load(this.getRootNode());this.searchIsOn=true}},this,{buffer:600})},getRelatedDescriptors:function(b,c){var a={};if(c.val.length){if(b==="doccb.owner.selected"){this.loader.baseParams.ownerfk=c.val;if(Ext.isDefined(this.loader.baseParams.typefk)){delete this.loader.baseParams.typefk}if(Ext.isDefined(this.loader.baseParams.statusfk)){delete this.loader.baseParams.statusfk}}else{if(b==="doccb.type.selected"){this.loader.baseParams.typefk=c.val;if(Ext.isDefined(this.loader.baseParams.statusfk)){delete this.loader.baseParams.statusfk}}else{if(b==="doccb.status.selected"){this.loader.baseParams.statusfk=c.val}}}delete this.getRootNode().attributes.children;this.loader.lastOptions=this.loader.baseParams;this.loader.load(this.getRootNode())}}});Ext.reg("descriptorstree",DocDb.DescriptorsTree);Ext.ns("DocDb");DocDb.DocumentDetails=Ext.extend(Ext.Panel,{border:false,initComponent:function(){this.tpl=new Ext.XTemplate('<div style="float:left;width:91%;">',"<b>"+this.LL.title+'</b> <a class="docpreview" href="{docPageURL}" title="'+this.LL.link2preview+'">{title}</a><br/>','<tpl if="owner.length &gt;1">',"<b>"+this.LL.owner+"</b> {owner}<br/>","</tpl>",'<tpl if="type.length &gt;1">',"<b>"+this.LL.type+"</b> {type}<br/>","</tpl>",'<tpl if="status.length &gt;1">',"<b>"+this.LL.status+"</b> {status}<br/>","</tpl>",'<tpl if="dkey.length &gt;1">',"<b>"+this.LL.key+"</b> {dkey}<br/>","</tpl>",'<tpl if="date !==0">',"<b>"+this.LL.date+'</b> {[this.fDate(values["date"])]}<br/>',"</tpl>","</div>",'<div style="float:right;width:8%;text-align:right;">','<a href="{docPageURL}" title="'+this.LL.link2page+'"><img class="x-docdetail-lint2page" src="'+Ext.BLANK_IMAGE_URL+'" /></a>',"</div>",{fDate:function(c){var d=new Date(c);return d.format("d.m.Y")}});Ext.apply(this,{bodyStyle:{background:"#ffffff",padding:"7px","font-size":"85%"},html:this.LL.helpText});DocDb.DocumentDetails.superclass.initComponent.call(this);this.on({scope:this,render:function(){this.body.on({scope:this,click:this.onClickLink,delegate:"a.docpreview",stopEvent:true})}})},restoreInitText:function(){this.body.update(this.LL.helpText)},updateDetail:function(b){this.tpl.overwrite(this.body,b);this.body.fadeIn({duration:1,block:true});this.resizeContainer()},resizeContainer:function(){var f=Ext.getCmp("gridResults");if(f.standaloneGrid){var e=Ext.getCmp("mainGrid")}else{var e=Ext.getCmp("mainPanel")}var g=Ext.getCmp("resultsPanel");var h=this.body.dom.firstElementChild.clientHeight+20;e.setHeight(f.getHeight()+h);g.setHeight(f.getHeight()+h);this.setHeight(h);e.syncSize()},onClickLink:function(e,a,f){if(!this.win){this.win=new Ext.Window({id:"docdb-previewWin",bodyStyle:"padding:13px",unstyled:false,maximizable:true,shadow:true,width:this.docDetail.pWinWidth,height:this.docDetail.pWinHeight,closeAction:"hide",autoScroll:true,constrain:true,url:a.href})}this.win.on("resize",function(){this.center()});this.win.setTitle(a.innerHTML);this.win.show();this.win.center();if(this.win.rendered){this.win.load({url:a.href,callback:function(c,h,d){var b=Ext.select("#docdb-previewWin div#"+this.docDetail.divContIdWinP,this.win.body.dom);this.win.body.update(b.elements[0].innerHTML)},scope:this},this)}}});Ext.reg("docdetail",DocDb.DocumentDetails);Ext.ns("DocDb");DocDb.GridResults=Ext.extend(Ext.grid.GridPanel,{border:false,initComponent:function(){var d=new Ext.ux.grid.RowExpander({tpl:new Ext.XTemplate('<div class="x-grid3-expander-preview">','<tpl if="this.cAr(dscr)">','<div><b>Related descriptor{[values["dscr"].length > 0?"s":""]}:</b>','<tpl for="dscr">',"<p>- {dtitle}</p>",'</tpl></div><hr class="hr4tmpl" />',"</tpl>",'<tpl if="this.cAr(pages)">','<div><b>Related page{[values["dscr"].length > 0?"s":""]}:</b>','<tpl for="pages">','<p>- <a href="{pUrl}" title="{pTitle}">{pTitle}</a></p>','</tpl></div><hr class="hr4tmpl" />',"</tpl>","</div>",{cAr:function(a){return a.length>0?true:false}})});var f=new Ext.ux.grid.GridFilters({encode:true,local:false,filters:[{type:"string",dataIndex:"title"},{type:"string",dataIndex:"owner"},{type:"date",dataIndex:"date"},{type:"string",dataIndex:"type"},{type:"string",dataIndex:"status"}]});var e={title:this.lang.resPanel.title,height:this.standaloneGrid?this.height:0,autoScroll:true,forceFit:true,autoExpandColumn:"title",autoSizeColumn:true,autoExpandMin:160,autoExpandMax:400,plugins:this.standaloneGrid?[d,f]:[d,f,new Ext.ux.plugins.HeaderButtons()],hbuttons:this.standaloneGrid?"":[{text:this.lang.resPanel.searchAgain,id:"btnMakeNewSearch",iconCls:"x-btn-search"}],loadMask:{msg:this.lang.loading},store:new Ext.data.GroupingStore({baseParams:{start:0,limit:10},autoLoad:false,remoteGroup:true,groupOnSort:false,remoteSort:true,groupField:"owner",sortInfo:{field:"title",direction:"ASC"},proxy:new Ext.data.DirectProxy({paramsAsHash:true,directFn:DocDb.model_document.get}),reader:new Ext.data.JsonReader({root:"rows",idProperty:"uid",totalProperty:"totalCount",fields:[{name:"uid",type:"int"},{name:"title",type:"string"},{name:"docPageURL",type:"string"},{name:"date",type:"date",dateFormat:"timestamp"},{name:"owner",type:"string"},{name:"dkey",type:"string"},{name:"type",type:"string"},{name:"status",type:"string"},{name:"dscr"},{name:"pages"}]})}),view:new Ext.grid.GroupingView({forceFit:false,hideGroupedColumn:true,showGroupName:false,groupTextTpl:"{text}"}),cm:new Ext.grid.ColumnModel([d,{id:"title",header:this.lang.header.title,width:250,sortable:true,dataIndex:"title",renderer:function(b,a,c){return'<div style="white-space:normal !important;">'+b+"</div>"}},{header:this.lang.header.date,width:60,fixed:true,resizable:false,sortable:true,renderer:Ext.util.Format.dateRenderer("d.m.y"),dataIndex:"date"},{header:this.lang.header.owner,width:130,sortable:true,dataIndex:"owner",renderer:function(b,a,c){return'<div style="white-space:normal !important;">'+b+"</div>"}},{header:this.lang.header.key,width:35,fixed:true,sortable:true,dataIndex:"dkey"},{header:this.lang.header.type,width:130,fixed:true,sortable:true,dataIndex:"type",renderer:function(b,a,c){return'<div style="white-space:normal !important;">'+b+"</div>"}},{header:this.lang.header.status,width:60,fixed:true,sortable:true,dataIndex:"status"}])};Ext.apply(this,Ext.apply(this.initialConfig,e));this.bbar=new Ext.PagingToolbar({id:"g-p-bbar",pageSize:this.pageSize,store:this.store,displayInfo:true,hidden:false,autoShow:true,plugins:[new Ext.ux.PageSizePlugin({editable:false,forceSelection:true})]});DocDb.GridResults.superclass.initComponent.apply(this,arguments)},afterRender:function(){this.store.on("beforeload",function(){if(this.baseParams.groupBy!=="owner"){this.groupBy(this.baseParams.groupBy)}if(!this.baseParams.grouping){this.groupBy("");this.clearGrouping()}});DocDb.GridResults.superclass.afterRender.apply(this,arguments)}});Ext.reg("gridresults",DocDb.GridResults);Ext.ns("DocDb");DocDb.DocGridResultDetails=Ext.extend(Ext.Panel,{initComponent:function(){Ext.applyIf(this,{frame:true,border:false,unstyled:true,layout:"border",items:[{xtype:"gridresults",id:"gridResults",lang:this.lang,pageSize:parseInt(this.pageSize,10),region:"north",height:this.standaloneGrid?parseInt(this.gridHeight,10):0,standaloneGrid:this.standaloneGrid,split:true,useSplitTips:true},{xtype:"docdetail",itemId:"detailPanel",id:"detailPanel",region:"center",docDetail:this.docDetail,LL:this.docDetailLL}]});DocDb.DocGridResultDetails.superclass.initComponent.call(this)},initEvents:function(){DocDb.DocGridResultDetails.superclass.initEvents.call(this);var b=this.getComponent("gridResults").getSelectionModel();b.on("rowselect",this.onRowSelect,this)},onRowSelect:function(g,h,e){var f=this.getComponent("detailPanel");f.updateDetail(e.data)}});Ext.reg("docgridresultdetail",DocDb.DocGridResultDetails);